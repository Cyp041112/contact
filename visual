def main():
    # åˆå§‹åŒ–æ•°æ®åº“
    init_db()
    # é¡µé¢åŸºç¡€è®¾ç½®
    st.set_page_config(page_title="åœ°å€ç°¿ç®¡ç†ç³»ç»Ÿ", page_icon="ğŸ“–", layout="wide")
    st.title("ğŸ“– åœ°å€ç°¿ç®¡ç†ç³»ç»Ÿï¼ˆè‡ªå®šä¹‰IDç‰ˆï¼‰")
    
    # ä¾§è¾¹æ ï¼šåŠŸèƒ½èœå•
    st.sidebar.title("åŠŸèƒ½èœå•")
    menu_option = st.sidebar.radio(
        "é€‰æ‹©æ“ä½œ",
        ["æ·»åŠ è”ç³»äºº", "æŸ¥çœ‹/ç®¡ç†è”ç³»äºº", "æ”¶è—è”ç³»äºº", "å¯¼å…¥/å¯¼å‡ºExcel"]
    )

    # 1. æ·»åŠ è”ç³»äººé¡µé¢ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šæ–°å¢IDè¾“å…¥æ¡†ï¼Œå¿…å¡«ï¼‰
    if menu_option == "æ·»åŠ è”ç³»äºº":
        st.subheader("âœ¨ æ·»åŠ æ–°è”ç³»äºº")
        with st.form(key="add_contact_form"):
            # ç¬¬ä¸€è¡Œï¼šIDï¼ˆå¿…å¡«ï¼‰+ å§“åï¼ˆå¿…å¡«ï¼‰
            col1, col2 = st.columns(2)
            with col1:
                # IDè¾“å…¥æ¡†ï¼šæ•´æ•°ã€å¿…å¡«ã€æœ€å°å€¼1
                contact_id = st.number_input("è”ç³»äººID*", min_value=1, step=1, help="è¯·è¾“å…¥å”¯ä¸€çš„æ•´æ•°IDï¼Œä¸å¯é‡å¤")
            with col2:
                name = st.text_input("å§“å*", placeholder="è¯·è¾“å…¥è”ç³»äººå§“åï¼ˆå¿…å¡«ï¼‰")
            
            # ç¬¬äºŒè¡Œï¼šç”µè¯ï¼ˆå¿…å¡«ï¼‰+ é‚®ç®±
            col3, col4 = st.columns(2)
            with col3:
                phone = st.text_input("ç”µè¯*", placeholder="è¯·è¾“å…¥è”ç³»äººç”µè¯ï¼ˆå¿…å¡«ï¼‰")
            with col4:
                email = st.text_input("é‚®ç®±", placeholder="è¯·è¾“å…¥è”ç³»äººé‚®ç®±ï¼ˆå¯é€‰ï¼‰")
            
            # ç¬¬ä¸‰è¡Œï¼šåˆ†ç±» + åœ°å€
            col5, col6 = st.columns(2)
            with col5:
                category = st.selectbox("åˆ†ç±»", ["æœ‹å‹", "åŒäº‹", "å®¶äºº", "å…¶ä»–"])
            with col6:
                address = st.text_area("åœ°å€", placeholder="è¯·è¾“å…¥è”ç³»äººåœ°å€ï¼ˆå¯é€‰ï¼‰", height=60)
            
            submit_btn = st.form_submit_button("æ·»åŠ è”ç³»äºº")
            
            if submit_btn:
                # æ ¡éªŒå¿…å¡«é¡¹ï¼ˆIDã€å§“åã€ç”µè¯ï¼‰
                if not contact_id:
                    st.error("âŒ è”ç³»äººIDä¸ºå¿…å¡«é¡¹ï¼")
                elif not name:
                    st.error("âŒ å§“åä¸ºå¿…å¡«é¡¹ï¼")
                elif not phone:
                    st.error("âŒ ç”µè¯ä¸ºå¿…å¡«é¡¹ï¼")
                else:
                    success, msg = add_contact(contact_id, name, phone, email, address, category)
                    if success:
                        st.success(msg)
                    else:
                        st.error(msg)

    # 2. æŸ¥çœ‹/ç®¡ç†è”ç³»äººé¡µé¢
    elif menu_option == "æŸ¥çœ‹/ç®¡ç†è”ç³»äºº":
        st.subheader("ğŸ“‹ æ‰€æœ‰è”ç³»äºº")
        df = get_all_contacts()
        if df.empty:
            st.info("æš‚æ— è”ç³»äººæ•°æ®ï¼Œå¿«å»æ·»åŠ å§ï¼")
        else:
            # æ˜¾ç¤ºè”ç³»äººè¡¨æ ¼ï¼ˆIDåˆ—ä¼˜å…ˆå±•ç¤ºï¼‰
            st.dataframe(df[['id', 'name', 'phone', 'email', 'category', 'æ”¶è—çŠ¶æ€']], use_container_width=True)
            
            # ç®¡ç†æ“ä½œï¼šä¿®æ”¹/åˆ é™¤
            st.subheader(âš™ï¸ è”ç³»äººç®¡ç†")
            contact_id = st.number_input("è¾“å…¥è¦æ“ä½œçš„è”ç³»äººID", min_value=1, step=1)
            col1, col2 = st.columns(2)
            with col1:
                if st.button("åˆ é™¤è”ç³»äºº"):
                    success, msg = delete_contact(contact_id)
                    if success:
                        st.success(msg)
                        st.rerun()  # åˆ·æ–°é¡µé¢
                    else:
                        st.error(msg)
            with col2:
                new_name = st.text_input("ä¿®æ”¹å§“å", placeholder="è¾“å…¥æ–°å§“å")
                if st.button("ä¿®æ”¹å§“å") and new_name:
                    success, msg = update_contact(contact_id, name=new_name)
                    if success:
                        st.success(msg)
                        st.rerun()
                    else:
                        st.error(msg)

    # 3. æ”¶è—è”ç³»äººé¡µé¢
    elif menu_option == "æ”¶è—è”ç³»äºº":
        st.subheader("â­ è”ç³»äººæ”¶è—")
        df = get_all_contacts()
        if df.empty:
            st.info("æš‚æ— è”ç³»äººæ•°æ®ï¼Œæ— æ³•æ”¶è—ï¼")
        else:
            contact_id = st.number_input("è¾“å…¥è¦æ”¶è—çš„è”ç³»äººID", min_value=1, step=1)
            col1, col2 = st.columns(2)
            with col1:
                if st.button("æ”¶è—è”ç³»äºº"):
                    success, msg = star_contact(contact_id, 1)
                    if success:
                        st.success(msg)
                        st.rerun()
                    else:
                        st.error(msg)
            with col2:
                if st.button("å–æ¶ˆæ”¶è—"):
                    success, msg = star_contact(contact_id, 0)
                    if success:
                        st.success(msg)
                        st.rerun()
                    else:
                        st.error(msg)
            
            # æ˜¾ç¤ºå·²æ”¶è—çš„è”ç³»äºº
            st.subheader("ğŸŒŸ å·²æ”¶è—çš„è”ç³»äºº")
            star_df = df[df['is_star'] == 1]
            if star_df.empty:
                st.info("æš‚æ— æ”¶è—çš„è”ç³»äºº")
            else:
                st.dataframe(star_df[['id', 'name', 'phone', 'category']], use_container_width=True)

    # 4. å¯¼å…¥/å¯¼å‡ºExcelé¡µé¢ï¼ˆé€‚é…è‡ªå®šä¹‰IDï¼‰
    elif menu_option == "å¯¼å…¥/å¯¼å‡ºExcel":
        st.subheader("ğŸ“¤ å¯¼å‡ºè”ç³»äººåˆ°Excel")
        if st.button("å¯¼å‡ºæ•°æ®"):
            success, msg = export_to_excel()
            if success:
                st.success(msg)
                # æä¾›ä¸‹è½½æŒ‰é’®
                with open("contact_data.xlsx", "rb") as f:
                    st.download_button(
                        label="ä¸‹è½½Excelæ–‡ä»¶",
                        data=f,
                        file_name="address_book_contacts.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
            else:
                st.error(msg)
        
        st.divider()
        st.subheader("ğŸ“¥ ä»Excelå¯¼å…¥è”ç³»äºº")
        st.caption("âš ï¸ Excelå¿…é¡»åŒ…å«åˆ—ï¼šidï¼ˆå¿…å¡«ï¼‰ã€nameï¼ˆå¿…å¡«ï¼‰ã€phoneï¼ˆå¿…å¡«ï¼‰ï¼Œå…¶ä»–åˆ—å¯é€‰")
        uploaded_file = st.file_uploader("é€‰æ‹©Excelæ–‡ä»¶", type=["xlsx"])
        if uploaded_file and st.button("å¯¼å…¥æ•°æ®"):
            success, msg = import_from_excel(uploaded_file)
            if success:
                st.success(msg)
            else:
                st.error(msg)

if __name__ == "__main__":
    main()
